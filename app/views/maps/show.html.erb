<%# params: @map %>
<%= turbo_stream_from @map %>
<%= turbo_stream_i18n_from @map %>
<div class="main-actions">
  <%= link_to t(".all_maps"), maps_path %>
  <h2><%= @map.name %></h2>
  <div class="main-actions-right">
    <%= link_to t("common.share"), map_access_groups_path(@map) if policy(@map.access_groups.new).index? %>
    <%= link_to t("helpers.link.map.delete"), @map, data: {turbo_method: :delete, turbo_confirm: t("common.confirm")} if policy(@map).destroy? %>
  </div>
</div>

<div
  class="data-with-map"
  data-action="mousemove@window->dragbar#mousemove mouseup@document->dragbar#mouseup"
  data-controller="map dragbar restricted"
  data-restricted-role-value="<%= "#{@role_type}-#{current_user.id}" %>">
  <div class="data" data-dragbar-target="left">
    <div class="map-data__container">
      <% @map.layers.includes(:last_updated_row_author, :fields, rows: :territory).each do |layer| %>
        <div
          class="layer-table__container"
          data-controller="layer layer-switch"
          data-action="layer:center->map#centerToContent"
        >
          <header class="layer-table__header"
            data-map-geometry-type-param="<%= layer.geometry_type %>"
            data-map-color-param="<%= layer.color %>">
            <h3><%= layer.name %></h3>
            <div class="layer-header__right-tools">
              <span class="layer-header__action"
                data-action="click->layer#center">
                <%= embedded_svg "frame.svg" %>
              </span>
              <button
                class="layer-table__chevron chevron"
                data-action="click->layer-switch#toggle click->map#layerSelected"
                data-map-layer-id-param="<%= layer.id %>">
              </button>
            </div>
          </header>
          <div class="layer-dropdown-content" data-layer-switch-target="content">
            <%= render "layers/rows", layer: layer %>
          </div>
        </div>
      <% end %>
      <%= link_to t("helpers.link.layer.new"), new_map_layer_path(@map), class: "primary-action" if policy(@map).update? %>
    </div>
  </div>
  <div class="dragbar" data-dragbar-target="dragbar" data-action="mousedown->dragbar#mousedown">
    <%= image_tag "dragbar_cursor.svg", alt: t("common.dragbar_cursor"), class: "svg-dragbar" %>
  </div>
  <div data-dragbar-target="right" class="right-pane">
    <div class="layer-actions action-bar">
      <%= button_with_icon t("common.add"), "add_circle.svg", data: {action: "click->map#toggleMode", map_target: "addButton"} %>
    </div>
    <div class="map" data-map-target="map">
    </div>
  </div>
</div>
</div>
